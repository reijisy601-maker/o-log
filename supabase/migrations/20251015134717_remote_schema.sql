revoke delete on table "public"."allowed_email_domains" from "anon";

revoke insert on table "public"."allowed_email_domains" from "anon";

revoke references on table "public"."allowed_email_domains" from "anon";

revoke select on table "public"."allowed_email_domains" from "anon";

revoke trigger on table "public"."allowed_email_domains" from "anon";

revoke truncate on table "public"."allowed_email_domains" from "anon";

revoke update on table "public"."allowed_email_domains" from "anon";

revoke delete on table "public"."allowed_email_domains" from "authenticated";

revoke insert on table "public"."allowed_email_domains" from "authenticated";

revoke references on table "public"."allowed_email_domains" from "authenticated";

revoke select on table "public"."allowed_email_domains" from "authenticated";

revoke trigger on table "public"."allowed_email_domains" from "authenticated";

revoke truncate on table "public"."allowed_email_domains" from "authenticated";

revoke update on table "public"."allowed_email_domains" from "authenticated";

revoke delete on table "public"."allowed_email_domains" from "service_role";

revoke insert on table "public"."allowed_email_domains" from "service_role";

revoke references on table "public"."allowed_email_domains" from "service_role";

revoke select on table "public"."allowed_email_domains" from "service_role";

revoke trigger on table "public"."allowed_email_domains" from "service_role";

revoke truncate on table "public"."allowed_email_domains" from "service_role";

revoke update on table "public"."allowed_email_domains" from "service_role";

revoke delete on table "public"."auth_allowed_domains" from "anon";

revoke insert on table "public"."auth_allowed_domains" from "anon";

revoke references on table "public"."auth_allowed_domains" from "anon";

revoke select on table "public"."auth_allowed_domains" from "anon";

revoke trigger on table "public"."auth_allowed_domains" from "anon";

revoke truncate on table "public"."auth_allowed_domains" from "anon";

revoke update on table "public"."auth_allowed_domains" from "anon";

revoke delete on table "public"."auth_allowed_domains" from "authenticated";

revoke insert on table "public"."auth_allowed_domains" from "authenticated";

revoke references on table "public"."auth_allowed_domains" from "authenticated";

revoke select on table "public"."auth_allowed_domains" from "authenticated";

revoke trigger on table "public"."auth_allowed_domains" from "authenticated";

revoke truncate on table "public"."auth_allowed_domains" from "authenticated";

revoke update on table "public"."auth_allowed_domains" from "authenticated";

revoke delete on table "public"."auth_allowed_domains" from "service_role";

revoke insert on table "public"."auth_allowed_domains" from "service_role";

revoke references on table "public"."auth_allowed_domains" from "service_role";

revoke select on table "public"."auth_allowed_domains" from "service_role";

revoke trigger on table "public"."auth_allowed_domains" from "service_role";

revoke truncate on table "public"."auth_allowed_domains" from "service_role";

revoke update on table "public"."auth_allowed_domains" from "service_role";

revoke delete on table "public"."auth_passcodes" from "anon";

revoke insert on table "public"."auth_passcodes" from "anon";

revoke references on table "public"."auth_passcodes" from "anon";

revoke select on table "public"."auth_passcodes" from "anon";

revoke trigger on table "public"."auth_passcodes" from "anon";

revoke truncate on table "public"."auth_passcodes" from "anon";

revoke update on table "public"."auth_passcodes" from "anon";

revoke delete on table "public"."auth_passcodes" from "authenticated";

revoke insert on table "public"."auth_passcodes" from "authenticated";

revoke references on table "public"."auth_passcodes" from "authenticated";

revoke select on table "public"."auth_passcodes" from "authenticated";

revoke trigger on table "public"."auth_passcodes" from "authenticated";

revoke truncate on table "public"."auth_passcodes" from "authenticated";

revoke update on table "public"."auth_passcodes" from "authenticated";

revoke delete on table "public"."auth_passcodes" from "service_role";

revoke insert on table "public"."auth_passcodes" from "service_role";

revoke references on table "public"."auth_passcodes" from "service_role";

revoke select on table "public"."auth_passcodes" from "service_role";

revoke trigger on table "public"."auth_passcodes" from "service_role";

revoke truncate on table "public"."auth_passcodes" from "service_role";

revoke update on table "public"."auth_passcodes" from "service_role";

revoke delete on table "public"."profiles" from "anon";

revoke insert on table "public"."profiles" from "anon";

revoke references on table "public"."profiles" from "anon";

revoke select on table "public"."profiles" from "anon";

revoke trigger on table "public"."profiles" from "anon";

revoke truncate on table "public"."profiles" from "anon";

revoke update on table "public"."profiles" from "anon";

revoke delete on table "public"."profiles" from "authenticated";

revoke insert on table "public"."profiles" from "authenticated";

revoke references on table "public"."profiles" from "authenticated";

revoke select on table "public"."profiles" from "authenticated";

revoke trigger on table "public"."profiles" from "authenticated";

revoke truncate on table "public"."profiles" from "authenticated";

revoke update on table "public"."profiles" from "authenticated";

revoke delete on table "public"."profiles" from "service_role";

revoke insert on table "public"."profiles" from "service_role";

revoke references on table "public"."profiles" from "service_role";

revoke select on table "public"."profiles" from "service_role";

revoke trigger on table "public"."profiles" from "service_role";

revoke truncate on table "public"."profiles" from "service_role";

revoke update on table "public"."profiles" from "service_role";

revoke delete on table "public"."sites" from "anon";

revoke insert on table "public"."sites" from "anon";

revoke references on table "public"."sites" from "anon";

revoke select on table "public"."sites" from "anon";

revoke trigger on table "public"."sites" from "anon";

revoke truncate on table "public"."sites" from "anon";

revoke update on table "public"."sites" from "anon";

revoke delete on table "public"."sites" from "authenticated";

revoke insert on table "public"."sites" from "authenticated";

revoke references on table "public"."sites" from "authenticated";

revoke select on table "public"."sites" from "authenticated";

revoke trigger on table "public"."sites" from "authenticated";

revoke truncate on table "public"."sites" from "authenticated";

revoke update on table "public"."sites" from "authenticated";

revoke delete on table "public"."sites" from "service_role";

revoke insert on table "public"."sites" from "service_role";

revoke references on table "public"."sites" from "service_role";

revoke select on table "public"."sites" from "service_role";

revoke trigger on table "public"."sites" from "service_role";

revoke truncate on table "public"."sites" from "service_role";

revoke update on table "public"."sites" from "service_role";

revoke delete on table "public"."submissions" from "anon";

revoke insert on table "public"."submissions" from "anon";

revoke references on table "public"."submissions" from "anon";

revoke select on table "public"."submissions" from "anon";

revoke trigger on table "public"."submissions" from "anon";

revoke truncate on table "public"."submissions" from "anon";

revoke update on table "public"."submissions" from "anon";

revoke delete on table "public"."submissions" from "authenticated";

revoke insert on table "public"."submissions" from "authenticated";

revoke references on table "public"."submissions" from "authenticated";

revoke select on table "public"."submissions" from "authenticated";

revoke trigger on table "public"."submissions" from "authenticated";

revoke truncate on table "public"."submissions" from "authenticated";

revoke update on table "public"."submissions" from "authenticated";

revoke delete on table "public"."submissions" from "service_role";

revoke insert on table "public"."submissions" from "service_role";

revoke references on table "public"."submissions" from "service_role";

revoke select on table "public"."submissions" from "service_role";

revoke trigger on table "public"."submissions" from "service_role";

revoke truncate on table "public"."submissions" from "service_role";

revoke update on table "public"."submissions" from "service_role";

drop function if exists "public"."admin_add_allowed_domain"(p_domain text);

drop function if exists "public"."admin_get_role_diagnostics"(email text, user_id uuid);

drop function if exists "public"."admin_list_allowed_domains"();

drop function if exists "public"."admin_list_passcodes"();

drop function if exists "public"."admin_list_profiles"();

drop function if exists "public"."admin_monthly_activity"(p_month date);

drop function if exists "public"."admin_remove_allowed_domain"(p_domain text);

drop function if exists "public"."admin_rotate_passcode"(p_code text, p_description text, p_valid_until timestamp with time zone);

drop function if exists "public"."admin_set_account_role"(p_user_id uuid, p_role text);

drop function if exists "public"."admin_soft_delete_profile"(p_id uuid);

drop function if exists "public"."admin_update_profile"(p_id uuid, p_employee_no text, p_first_name text, p_last_name text, p_site_id uuid, p_manager_id uuid, p_notes text, p_first_login_completed boolean);

drop function if exists "public"."assert_admin"();

drop function if exists "public"."is_admin"();

drop function if exists "public"."is_domain_allowed"(p_email text);

drop function if exists "public"."mark_first_login_completed"(p_first_name text, p_last_name text, p_site_id uuid, p_employee_no text, p_notes text);

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
begin
  insert into public.profiles (id, email, role)
  values (new.id, new.email, 'user')
  on conflict (id) do update set email = excluded.email;
  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.is_valid_signup_passcode(p_code text)
 RETURNS boolean
 LANGUAGE sql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  select exists(
    select 1
    from public.auth_passcodes
    where is_active
      and code = p_code
      and valid_from <= now()
      and (valid_until is null or valid_until >= now())
  );
$function$
;

CREATE OR REPLACE FUNCTION public.register_magic_link(p_email text, p_passcode text DEFAULT NULL::text)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
declare
  v_exists boolean;
begin
  if p_email is null or position('@' in p_email) = 0 then
    raise exception 'invalid_email';
  end if;
  select exists(select 1 from auth.users where lower(email) = lower(p_email)) into v_exists;
  if v_exists then
    return;
  end if;
  if p_passcode is null or not public.is_valid_signup_passcode(p_passcode) then
    raise exception 'invalid_passcode';
  end if;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.touch_profiles_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
begin
  new.updated_at = now();
  return new;
end $function$
;



